
# LDAP Authentik Setup Guide

This guide will help you set up LDAP in Authentik using Certbot certificates to ensure secure and verified connections.

## Prerequisites

- **Authentik Installed**: Ensure Authentik is installed and running.
- **Certbot Certificate**: You should have an SSL certificate generated by Certbot.

## References

- [Authentik LDAP Provider Documentation](https://docs.goauthentik.io/docs/providers/ldap/generic_setup)
- [Video Tutorial](https://www.youtube.com/watch?v=RtPKMMKRT_E)

## Step-by-Step Guide

### 1. Install Certbot and Obtain Certificates

Follow the previous guide to install Certbot and obtain SSL certificates using Cloudflare DNS.

### 2. Copy Certificates to Authentik /certs Directory

Ensure your certificates are copied to the Authentik `/certs` directory. The directory layout should be as follows:

```
- certs
  - example.com
    - cert1
    - cert2
    - cert3
    - cert4
```

Use the provided `copy_certs.sh` script to automate this process.

### 3. Create User and Group in Authentik

1. **Create User**:
   - Navigate to **Directory** -> **Users** -> **Create**.
   - Create a new user account, e.g., `ldapservice`.

2. **Create Group**:
   - Navigate to **Directory** -> **Groups** -> **Create**.
   - Create a new group, e.g., `ldapsearch`.
   - Add the `ldapservice` user to this group.

### 4. Create Custom LDAP Flow

1. **Create Identification Stage**:
   - Navigate to **Flows & Stages** -> **Stages** -> **Create**.
   - Name it `ldap-identification-stage` and select Username and Email as User fields.

2. **Create Password Stage**:
   - Navigate to **Flows & Stages** -> **Stages** -> **Create**.
   - Name it `ldap-authentication-password` and leave the defaults.

3. **Create User Login Stage**:
   - Navigate to **Flows & Stages** -> **Stages** -> **Create**.
   - Name it `ldap-authentication-login`.

4. **Create Authentication Flow**:
   - Navigate to **Flows & Stages** -> **Flows** -> **Create**.
   - Name it `ldap-authentication-flow`.
   - Bind the stages: `ldap-identification-stage` (order: 10) and `ldap-authentication-login` (order: 30).
   - Edit `ldap-identification-stage` to change the Password stage to `ldap-authentication-password`.

### 5. Create LDAP Provider

1. **Create LDAP Provider**:
   - Navigate to **Applications** -> **Providers** -> **Create**.
   - Name it `LDAP`, bind the custom flow created, and specify the search group `ldapsearch`.
   - Select the Certbot certificate and enter your Authentik domain name for TLS domain to verify the certificate.

### 6. Create LDAP Application

1. **Create LDAP Application**:
   - Navigate to **Applications** -> **Applications** -> **Create**.
   - Name it `LDAP` and choose the LDAP provider created in the previous step.

### 7. Create LDAP Outpost

1. **Create LDAP Outpost**:
   - Navigate to **Applications** -> **Outposts** -> **Create**.
   - Set the Type to `LDAP` and choose the `LDAP` application created in the previous step.

### 8. Test LDAP Configuration

Use `ldapsearch` to test connectivity:

```bash
ldapsearch   -x   -H ldap://<LDAP Outpost IP address>:389   -D 'cn=ldapservice,ou=users,dc=example,dc=com'   -w '<ldapuserpassword>'   -b 'dc=example,dc=com'   '(objectClass=user)'
```

## Conclusion

By following this guide, you should have a securely configured LDAP provider in Authentik using Certbot certificates. This setup ensures that your certificates are verified and your connections are secure.